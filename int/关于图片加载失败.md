### 版本号对比函数

```
export function compareVersion(v1, symb, v2) {
  v1 = parseVersion(v1)
  v2 = parseVersion(v2)

  if (symb.indexOf('=') !== -1 && v1 === v2) {
    return true
  }

  if (symb.indexOf('>') !== -1 && v1 > v2) {
    return true
  }

  if (symb.indexOf('<') !== -1 && v1 < v2) {
    return true
  }

  return false
}

function parseVersion(version = '') {
  version = version.split('.')
  version.length = 4
  let ret = []
  version.forEach(function (n) {
    n = n * 1

    if (n) {
      ret.push(n >= 10 ? n : '0' + n)
    } else {
      ret.push('00')
    }
  })
  return parseInt(ret.join(''), 10)
}
```
### 图片加载成功和失败埋点mixin

```
/**
 * 获取图片mixin埋点方法
 */
import Omega from 'common/js/omega'
import { getMixin } from '@mpxjs/core'
const getImageMixin = (compType = '') => {
  return getMixin({
    methods: {
      comShow() {
        Omega.trackEvent('wyc_load_image_data_sw', '图片下发挂载', {
          type: compType
        })
      },
      // type: home_market
      onImageLoad(image: string, e: any, index = -1) {
        // 比较多的情况下只上报两个防止出现过多埋点的情况
        if (index < 2) {
          Omega.trackEvent('wyc_load_image_load_sw', '图片加载', {
            image,
            type: compType,
            index,
            requestCount: e?.detail?.requestCount
          })
        }
      },
      // index 为图片所在索引，减少一些上报
      onImageError(image: string, e: any, index = -1) {
        Omega.trackEvent('wyc_load_image_error_sw', '图片加载失败', {
          image,
          type: compType,
          index,
          error: e?.detail?.errMsg,
          requestCount: e?.detail?.requestCount
        })
      }
    }
  })
}
export default getImageMixin

```
### 处理图片格式

```
export const isSupportWebp = (src:string) => {
  if (__mpx_env__ === 'ali' || !src) return false
  const { SDKVersion, platform } = mpx.getSystemInfoSync()
  if (platform === 'ios' && compareVersion(SDKVersion, '2.9.0') < 0) return false

  return false
}

export const buildImgUrl = (src:string) => {
  const prefix = 'x-s3-process=image/webp'
  const isWebp = isSupportWebp(src)
  if (/\.(gif|webp)/.test(src)) {
    return src
  } else if (isWebp) {
    return `${src}${~src.indexOf('?') ? '?' : '&'}${prefix}`
  }
  return src
}

```
#### webp

```
webp是一种同时提供了有损压缩与无损压缩的，并且是可逆的图片压缩的这种文件格式，这种文件是由谷歌推出的。image组件它默认是不解析webp这种图片格式的，它只支持图片的网络资源，只有开启了webp属性以后才可以解析webp这种图片网址。

webp 的优势体现在它具有更优的图像数据压缩算法，能带来更小的图片体积，并且拥有肉眼识别无差异的图像质量

export const isSupportWebp = (src:string) => {
  if (__mpx_env__ === 'ali' || !src) return false
  const { SDKVersion, platform } = mpx.getSystemInfoSync()
  if (platform === 'ios' && compareVersion(SDKVersion, '2.9.0') < 0) return false

  return false
}

export const buildImgUrl = (src:string) => {
  const prefix = 'x-s3-process=image/webp'
  const isWebp = isSupportWebp(src)
  if (/\.(gif|webp)/.test(src)) {
    return src
  } else if (isWebp) {
    return `${src}${~src.indexOf('?') ? '?' : '&'}${prefix}`
  }
  return src
}

```
### image标签

```
<common-image
          class="main-card-swiper-image"
          src="{{item.image}}"
          openImageRetry="{{true}}"
          imageAnalysis="{{ {open: true, tag: item.id + index} }}"
          bindretry="onImageError(item.image, $event)"
          binderror="onImageError(item.image, $event)"
          bindload="onImageLoad(item.image, $event)"
        ></common-image>

```

```
<template>
  <image
    wx:if="{{src}}"
    src="{{url || src}}"
    mode="{{mode}}"
    webp="{{webp}}"
    lazy-load="{{lazyLoad}}"
    show-menu-by-longpress = "{{showMenuByLongPress}}"
    binderror="errHandler"
    bindload="loadHander"
    class="img-preload-wrap"
  />
</template>

<script>
  import { createComponent } from '@mpxjs/core'
  const Omega = getApp().Omega

  createComponent({
    data: {
      url: '',
      requestCount: 0
    },
    properties: {
      src: {
        type: String,
        value: ''
      },
      mode: {
        type: String,
        value: 'scaleToFill'
      },
      webp: {
        type: Boolean,
        value: false
      },
      lazyLoad: {
        type: Boolean,
        value: false
      },
      showMenuByLongPress: {
        type: Boolean,
        value: false
      },
      // 以下额外添加的一些功能
      // 是否开启图片加载率分析上报
      imageAnalysis: {
        type: Object,
        value: {
          open: false, // 是否开启图片分析，每次分析都会上报一套omega埋点，请勿批量添加
          tag: '' // 类型标识，会用于分析image的时候
        }
      },
      // 开启在图片加载失败的时候进行一次自动重试操作
      openImageRetry: {
        type: Boolean,
        value: false
      }
    },
    watch: {
      src: {
        handler(val) {
          if (val && this.imageAnalysis?.open) {
            Omega.trackEvent('tech_mini_image_data_sw', {
              imageSrc: this.src,
              tag: this.imageAnalysis?.tag
            })
          }
        },
        immediate: true
      }
    },
    detached() {
      (!this.requestCount && this.src) && Omega.trackEvent('tech_mini_image_unload_sw', {
        imageSrc: this.src,
        tag: this.imageAnalysis?.tag
      })
    },
    methods: {
      errHandler(e) {
        this.requestCount++
        // 请求重试
        if (this.openImageRetry) {
          this.openImageRetry = false
          this.url = this.src + '?timestamp=' + Date.now()
        }
        const triggerName = this.requestCount === 2 ? 'retry' : 'error'
        this.triggerEvent(triggerName, {
          err: e,
          requestCount: this.requestCount
        })
        Omega.trackEvent('tech_mini_image_error_sw', {
          imageSrc: this.requestCount === 2 && this.url ? this.url : this.src,
          tag: this.imageAnalysis?.tag,
          err: e.detail?.errMsg,
          requestCount: this.requestCount
        })
      },
      loadHander(e) {
        this.requestCount++
        this.triggerEvent('load', {
          err: e,
          requestCount: this.requestCount
        })
        Omega.trackEvent('tech_mini_image_load_sw', {
          imageSrc: this.url || this.src,
          tag: this.imageAnalysis?.tag,
          requestCount: this.requestCount
        })
      }
    }

  })
</script>

<style lang="stylus" scoped>
  .img-preload-wrap
    height 100%
    width 100%
</style>

```
### 前端性能优化之支持webp图片的加载
[文章链接](https://juejin.cn/post/7002031688570126366)